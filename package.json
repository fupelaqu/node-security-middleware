{
  "author": {
    "name": "Stephane Manciot",
    "email": "stephane.manciot@gmail.com"
  },
  "name": "security-middleware",
  "description": "security middleware for connect/express.",
  "version": "0.0.3rc1",
  "repository": {
    "type": "git",
    "url": "git://github.com/fupelaqu/node-security-middleware.git"
  },
  "main": "./lib/middleware.js",
  "scripts": {
    "test": "expresso test/*"
  },
  "dependencies": {
    "connect": "2.4.x"
  },
  "devDependencies": {
    "express": "3.0.x",
    "ejs": "0.8.x",
    "less-middleware": "0.1.x"
  },
  "optionalDependencies": {},
  "engines": {
    "node": "0.8.x"
  },
  "_id": "security-middleware@0.0.3",
  "_from": "security-middleware@*",
  "readme": "node-security-middleware\n========================\n\n## About\n\nnode-security-middleware is a security middleware for [Connect](http://senchalabs.github.com/connect/)/[Express](http://expressjs.com/)\n\nIt supplies both BASIC and FORM authentication, as well as authorization based on an Access Control List.\nThe latter is a set of rules that can be defined per url and rely on privileges and roles granted to the authenticated user.\nThe authentication as well as the authorization mechanisms rely on a store which will be used to retrieve the user credentials as well as its roles and privileges.\n\nInstallation\n====================\n\n    $ npm install security-middleware\n\nUsing It\n====================\n\n### Configure security-middleware within express\n\n```javascript\n    var security = require('security-middleware')\n    , inMemoryStore = require('security-middleware/lib/security.js').inMemoryStore;\n\n    var app = express();\n\n    app.configure(function(){\n    ...\n      app.use(security({ \n        debug : false, // for debug purpose\n        realmName : 'Express-security', // realm name\n        store : inMemoryStore, // store which will be used to retrieve user information - inMemoryStore by default if none specified\n        rememberMe : true, // whether a cookie will be set after authentication or not - false by default\n        secure : true, // whether to use secured cookies or not - false by default\n        credentialsMatcher: 'sha256', // a credentialsMatcher must be provided to check if the provided token credentials match the stored account credentials using the encryption algorithm specified\n        loginUrl : '/login', // url used by the application to sign in - `/login` by default\n        usernameParam : 'username', // name of the username parameter which will be used during form authentication - `username` by default\n        passwordParam : 'password', // name of the password parameter which will be used during form authentication - `password` by default\n        logoutUrl : '/logout', // url used by the application to sign out - `/logout` by default\n        acl : [ // array of Access Controls to apply per url\n               {\n                   url : '/admin', // web resource (s) on which this access control will be applied - `/*` if none specified\n                   methods : 'GET, POST', // HTTP method (s) for which this access control will be applied (GET, POST, PUT, DELETE or * for ALL) - `*` by default\n                   authentication : 'BASIC', // authentication type - FORM or BASIC\n                   rules : '(([role=user] && [permission=admin]) || [role=admin])' // access control rules to check\n               },\n               {\n                   url : '/products/list',\n                   methods : 'GET',\n                   authentication : 'FORM',\n                   // a rule can be based on query parameter (s) which will be valued at runtime (eg {idCompany})\n                   rules : '(([role=user] && [permission=products:company_{idCompany}:list]) || [role=admin])'\n               }\n        ]\n      }));\n      ...\n    });\n\n```\n\n### Use FORM authentication within express\n\nWhenever an access control applies to an unauthenticated or unauthorized user, the client is automatically redirected to the `loginUrl` defined for the security middleware.\n\nThe login form should include `usernameParam` and `passwordParam` as defined for the security middleware.\n\n```javascript\napp.get('/login', function(req, res){\n  res.render('login', { username: req.param('username') });\n});\n```\n\nThe login form may also include a `redirect` input so as to automatically redirect the client to the uri initially requested after authentication completion.\n\n```javascript\napp.get('/login', function(req, res){\n  res.render('login', { username: req.param('username'), redirect : req.param('redirect') });\n});\n```\n\n```html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>Login</title>\n  </head>\n  <body>\n    <h1>Login</h1>\n    <form method=\"post\">\n      <input type=\"text\" name=\"username\" placeholder=\"Type your login\" autofocus required<% if (username) { %> value=\"<%= username %>\"<% } %>>\n      <input type=\"password\" name=\"password\" placeholder=\"Type your password\" required>\n      <input type=\"hidden\" name=\"redirect\"<% if (redirect) { %> value=\"<%= redirect %>\"<% } %>>\n      <input type=\"submit\">\n    </form>\n  </body>\n</html>\n```\n\n### Use inMemoryStore\n\nThe inMemoryStore should not be used in a production environment. It may nevertheless be useful during the development phase.\n\nIt allows to save in memory both users and roles as in the example below.\n\n```javascript\nvar inMemoryStore = require('security-middleware/lib/security.js').inMemoryStore\n, credentialsMatcher = require('security-middleware/lib/security.js').sha256CredentialsMatcher \n, encryptedPassword = credentialsMatcher.encrypt('changeit');\n\ninMemoryStore.storeRole({\n    name : 'user', // must be unique\n    privileges : [] // may be empty or null\n});\n\ninMemoryStore.storeRole({\n    name : 'admin',\n    privileges : [ 'admin:*' ]\n});\n\ninMemoryStore.storeAccount({\n    username : 'user', // must be unique\n    password : encryptedPassword, // must be encrypted using the same encryption algorithm which will be used by the security middleware\n    roles : ['user'], // set of roles granted to the user\n    privileges : [ 'products:company_1:list', 'products:company_1:show:*' ] // set of privileges granted to the user\n});\n\ninMemoryStore.storeAccount({\n    username : 'admin',\n    password : encryptedPassword,\n    roles : [ 'user', 'admin' ],\n    privileges : []\n});\n\n```\n\n### Define a custom Store\n\nA custom Store must conform to the interface below :\n\n```javascript\n/**\n * Returns the user mapped to this username or null\n * \n * If exists, the returned object should include the user's password\n * \n * @param username\n * @returns the user mapped to this username or null\n */\nStore.prototype.lookup = function(username) {\n    ...\n};\n\n/**\n * Returns the roles granted to the user mapped to this username as an array of string\n * \n * @param username\n * @returns the roles granted to the user mapped to this username as an array of string\n */\nStore.prototype.loadUserRoles = function(username) {\n    ...\n};\n\n/**\n * Returns the privileges granted to the user mapped to this username as an array of string\n * \n * @param username\n * @returns the privileges granted to the user mapped to this username as an array of string\n */\nStore.prototype.loadUserPrivileges = function(username) {\n    ...\n};\n\n/**\n * Returns the privileges granted to the role mapped to this role name as an array of string\n * \n * @param roleName\n * @returns the privileges granted to the role mapped to this role name as an array of string\n */\nStore.prototype.loadRolePrivileges = function(roleName) {\n    ...\n};\n\n```\n\n### Define an Access Control\n\n#### Define an Access Control mapping\n\nAn Access Control mapping is looked up for every client request based on the url requested as well as the http method.\n\nFor instance, for the following request,\n\n    GET /products/1/list\n\na matching will be looked up as follow :\n \nAccessControl contains `GET` or `*` method and has been defined for one of the following url :\n\n    /products/1/list\n    /products/1/list/* \n    /products/1/*\n    /products/*\n    /*\n\n```javascript\n{\n    url : '/products/list',\n    methods : 'GET',\n    authentication : 'FORM',\n    rules : '(([role=user] && [permission=products:company_{idCompany}:list]) || [role=admin])'\n}\n```\n\nwill apply to :\n\n    GET /products/list\n\n\n```javascript\n{\n    url : '/products',\n    methods : 'GET',\n    authentication : 'FORM',\n    rules : '(([role=user] && [permission=products:company_{idCompany}:show:product_{idProduct}]) || [role=admin])'\n}\n```\n\nwill apply to :\n\n    GET /products\n\n```javascript\n{\n    url : '/products',\n    methods : 'PUT',\n    authentication : 'FORM',\n    rules : '(([role=user] && [permission=products:company_{idCompany}:create]) || [role=admin])'\n}\n```\n\nwill apply to :\n\n    PUT /products\n\n```javascript\n{\n    url : '/products',\n    methods : 'POST',\n    authentication : 'FORM',\n    rules : '(([role=user] && [permission=products:company_{idCompany}:update]) || [role=admin])'\n}\n```\n\nwill apply to :\n\n    POST /products\n\n```javascript\n{\n    url : '/products',\n    methods : 'DELETE',\n    authentication : 'FORM',\n    rules : '(([role=user] && [permission=products:company_{idCompany}:delete]) || [role=admin])'\n}\n``` \n\nwill apply to :\n\n    DELETE /products\n\n#### Define Access Control rules\n\nAccess Control rules are based on a set of role (s) and/or permission (s) which must have been granted to the authenticated user in order to authorize the latter to access the requested web ressource.\n\nA required role is defined as follow :\n\n    [role=roleName]\n\nA required permission is defined as follow :\n\n    [permission=permissionRule]\n\nIt is also possible to specify permissions based on request parameters that will be evaluated at runtime.\n\nA request parameter `parmaterName` may be added using the following syntax :\n\n    {parmaterName}\n\nThe following permission\n\n    [permission=products:company_{idCompany}:list]\n\nthat applies to\n\n    GET /products/list?idCompany=1\n\nwill be evaluated at runtime as below :\n\n    products:company_1:list\n\nFinally, Access Control rules may use logical operators.\n\nFor instance, for the following request,\n\n\tGET /products/list?idCompany=1\n\nThe following Access Control rules will apply\n\n    '(([role=user] && [permission=products:company_{idCompany}:list]) || [role=admin])'\n\nfor which a matching will be looked up as follow :\n\nThe role `user` has been granted to the authenticated user `and` one of the following privilege has been granted to the authenticated user :\n\n    products:company_1:list\n    products:company_1:list:*\n    products:company_1:*\n    products:*\n    *\n\n`or` the role `admin` has been granted to the authenticated user\n\n### Subject api\n\nAn instance of Subject is added to all incoming requests and can be accessed as in the example below :\n\n```javascript\napp.get('/products/list', function(req, res){\n    var subject = req.subject;\n    ...\n});\n\n```\n\nSubject defines the api described below :\n\n```javascript\n/**\n * Returns this Subject's uniquely-identifying principal, or null \n * if this Subject doesn't yet have account data associated with it\n */\nSubject.prototype.getPrincipal = function(){\n...\n}\n/**\n * Returns true if this Subject has the specified role, false otherwise.\n */\nSubject.prototype.hasRole = function(roleName){\n...\n}\n/**\n * Returns true if this Subject has all of the specified roles, false otherwise.\n */\nSubject.prototype.hasAllRoles = function(roles){\n...\n};\n/**\n * Returns true if the Subject is permitted to perform an action or access a \n * resource summarized by the specified permission string.\n */\nSubject.prototype.isPermitted = function(permission) {\n...\n};\n/**\n * Returns true if the Subject implies all of the specified permission strings.\n */\nSubject.prototype.isPermittedAll = function(permissions) {\n...\n};\n/**\n * Returns true if this Subject/user has proven their identity during their current session\n * by providing valid credentials matching those known to the system, false otherwise.\n */\nSubject.prototype.isAuthenticated = function(){\n...\n};\n/**\n * Performs a login attempt for this Subject/user. If unsuccessful, an error is thrown.\n * If successful, the account data associated with the submitted principals/credentials \n * will be associated with this Subject and the method will return quietly.\n * \n * Upon returninq quietly, this Subject instance can be considered authenticated \n * and getPrincipal() will be non-null and isAuthenticated() will return true.\n */\nSubject.prototype.login = function(token){\n...\n};\n/**\n * Logs out this Subject and invalidates and/or removes any associated entities \n * and authorization data.\n */\nSubject.prototype.logout = function(){\n...\n};\n\n```\n\nA call to Subject.login requires a token which should be initialized using `UsernamePasswordToken` :\n\n```javascript\nvar UsernamePasswordToken = require('security-middleware/lib/security.js').UsernamePasswordToken;\n// user's password should not be encrypted within a token, otherwise the credentials matcher will not work\nsubject.login(new UsernamePasswordToken(username, password, rememberMe));\n\n```\n"
}
